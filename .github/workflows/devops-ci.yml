name: CI Workflow


# ------------------------------------------------------------------------------


on:
  push:
  pull_request:
    types: [ opened, synchronize, reopened ]


# ------------------------------------------------------------------------------


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


# ------------------------------------------------------------------------------


jobs:

  # Job
  validate:
    name: Validate Conventions
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:

      # Step
      - name: Branches
        shell: bash
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"

          echo "🔍 Validating branch: $BRANCH_NAME"
          
          if [[ "$BRANCH_NAME" =~ ^(main|staging|topic\/[a-z0-9-]+|debug\/[a-z0-9-]+|tests\/[a-z0-9-]+|rollback\/[a-z0-9-]+|refs\/tags\/v[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "✅ Follows accepted conventions."
            exit 0
          else
            echo "❌ Invalid branch name: '$BRANCH_NAME'                  "
            echo "Allowed conventions:                                    "
            echo "  - main                                                "
            echo "  - staging                                             "
            echo "  - rollback/<lowercase-name> (letters, numbers, dashes)"
            echo "  - topic/<lowercase-name> (letters, numbers, dashes)   "
            echo "  - debug/<lowercase-name> (letters, numbers, dashes)   "
            echo "  - tests/<lowercase-name> (letters, numbers, dashes)   "
            echo "  - refs/tags/vX.Y.Z (semantic version tags)            "
            exit 1
          fi
  

  # Job
  node-build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate
    if: |
      needs.validate.result == 'success' || 
      github.event_name == 'pull_request'
    timeout-minutes: 10
    steps:

      # Step
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # Step
      - name: Setup the NodeJs Environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Step
      - name: Install & Build
        shell: bash
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          
          npm run build || BUILD_EXIT_CODE=$?
          if [ -n "$BUILD_EXIT_CODE" ]; then
            echo "❌ Build completed with TypeScript errors (non-blocking)"
          else
            echo "✅ Build completed successfully"
          fi


# ------------------------------------------------------------------------------
